<% layout('/layout/boilerplate') -%>

<!-- ================= TABULATOR CSS ================= -->
<link
  href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
  rel="stylesheet"
/>

<div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
  <div class="indi-head">
    <h1>Clients</h1>

    <div class="download-selector" id="downloadSelector">
      <button class="download-selector__trigger">
        <span>
          <i class="fa-solid fa-file-arrow-down"></i> Download
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>

      <div class="download-selector__menu">
        <div class="download-selector__option" id="download-pdf">
          <i class="fas fa-file-pdf"></i> PDF
        </div>
        <div class="download-selector__option" id="download-xlsx">
          <i class="fas fa-file-excel"></i> Excel
        </div>
      </div>
    </div>
  </div>

  <div id="master-table"></div>
</div>

<!-- ================= CLIENT DETAILS POPUP ================= -->
<style>
  .client-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .client-modal {
    background: #f8f9fa;
    border: 1px solid #1a1a2e;
    border-radius: 8px;
    width: 85%;
    max-width: 820px;
    overflow: hidden;
  }

  .client-modal-header {
    background: #1a1a2e;
    color: white;
    padding: 6px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .client-modal-title {
    font-size: 1rem;
    font-weight: 600;
  }

  .client-modal-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .client-edit-btn {
    color: #1a1a2e;
    background: #fff;
    padding: 0px 10px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    text-decoration: none;
    transition: opacity 0.15s ease;
  }

  .client-edit-btn:hover {
    opacity: 0.85;
  }

  .client-close {
    cursor: pointer;
    font-size: 1rem;
  }

  .client-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
  }

  .client-field {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(26, 26, 46, 0.25);
    border-right: 1px solid rgba(26, 26, 46, 0.25);
  }

  .client-field:nth-child(2n) {
    border-right: none;
  }

  .client-label {
    font-size: 11px;
    color: #6c757d;
  }

  .client-value {
    font-size: 13px;
    font-weight: 500;
    color: #1a1a2e;
  }

  @media (max-width: 700px) {
    .client-grid {
      grid-template-columns: 1fr;
    }
    .client-field {
      border-right: none;
    }
  }
</style>

<div class="client-modal-backdrop" id="clientModal">
  <div class="client-modal">
    <div class="client-modal-header">
      <div class="client-modal-title" id="clientModalTitle"></div>

      <div class="client-modal-actions">
        <a id="editClientBtn" class="client-edit-btn">Edit</a>
        <span class="client-close" onclick="closeClientModal()">âœ•</span>
      </div>
    </div>

    <div class="client-grid" id="clientModalBody"></div>
  </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  /* ===== Dropdown ===== */
  const downloadSelector = document.getElementById("downloadSelector");
  const triggerBtn = downloadSelector.querySelector(".download-selector__trigger");

  triggerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    downloadSelector.classList.toggle("download-selector--active");
  });

  document.addEventListener("click", () => {
    downloadSelector.classList.remove("download-selector--active");
  });

  /* ===== Table ===== */
  const tableData = <%- JSON.stringify(jsonData) %>;

  const table = new Tabulator("#master-table", {
    data: tableData,
    layout: "fitColumns",
    pagination: "local",
    paginationSize: 25,

    columns: [
      {
        title: "Client Name",
        field: "clientName",
        minWidth: 220,
        headerFilter: true,

        formatter: (cell) => {
          cell.getElement().classList.add("client-name-cell");
          return cell.getValue();
        },
      
        cellClick: (e, cell) => {
          const row = cell.getRow().getData();
          openClientModal(row._id);
        },
      },
      { title: "Type", field: "clientType" },
      { title: "HO Location", field: "hoLocation" },
      { title: "Account Head", field: "accountHead" },
      {
        title: "Status",
        field: "clientStatus",
        formatter: (cell) => {
          const v = cell.getValue();
          const color = v === "ACTIVE" ? "#28a745" : "#dc3545";
          return `<span style="font-weight:600;color:${color}">${v}</span>`;
        },
      },
    ],
  });

  /* ===== POPUP LOGIC ===== */
  async function openClientModal(id) {
    const res = await fetch(`/fairdesk/client/api/${id}`);
    const client = await res.json();

    document.getElementById("clientModalTitle").innerText = client.clientName;
    document.getElementById("editClientBtn").href =
      `/fairdesk/client/edit/${client._id}`;

    const fields = [
      ["Client ID", client.clientId],
      ["Type", client.clientType],
      ["Status", client.clientStatus],
      ["HO Location", client.hoLocation],
      ["Account Head", client.accountHead],
      ["GST", client.clientGst],
      ["PAN", client.clientPan],
      ["MSME", client.clientMsme],
      ["Gumasta", client.clientGumasta],
    ];

    const body = document.getElementById("clientModalBody");
    body.innerHTML = "";

    fields.forEach(([label, value]) => {
      body.innerHTML += `
        <div class="client-field">
          <div class="client-label">${label}</div>
          <div class="client-value">${value || "-"}</div>
        </div>
      `;
    });

    document.getElementById("clientModal").style.display = "flex";
  }

  function closeClientModal() {
    document.getElementById("clientModal").style.display = "none";
  }
</script>

<!-- ================= FLOATING ACTION BUTTONS ================= -->
<style>
  .fab-capsule {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: #1a1a2e;
    border-radius: 50px;
    display: flex;
    align-items: center;
    padding: 6px 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    z-index: 1000;
  }

  .fab-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    color: #fff;
    text-decoration: none;
    font-size: 18px;
    border-radius: 50%;
    transition: background 0.2s, transform 0.2s;
  }

  .fab-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.05);
    color: #fff;
  }

  .fab-divider {
    width: 2px;
    height: 24px;
    background: rgba(255, 255, 255, 0.2);
    margin: 0 8px;
    border-radius: 2px;
  }
</style>

<div class="fab-capsule">
  <div title="Add Client" class="fab-item" onclick="window.location.href='/fairdesk/form/client?tab=client'" style="cursor: pointer;">
    <i class="fa-solid fa-building"></i>
  </div>
  <div class="fab-divider"></div>
  <div title="Add User" class="fab-item" onclick="window.location.href='/fairdesk/form/client?tab=user'" style="cursor: pointer;">
    <i class="fa-solid fa-user-plus"></i>
  </div>
</div>