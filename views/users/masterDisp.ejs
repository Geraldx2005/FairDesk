<!-- Link to boilerplate.ejs -->
<% layout('/layout/boilerplate') -%>

<!-- Tabulator CSS -->
<link
  href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
  rel="stylesheet"
/>

<style>
  
</style>
</head>

<body>
  <div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
    <div class="indi-head">
      <h1>Master display</h1>
      <div class="download-btns">
        <div class="download-selector" id="downloadSelector">
          <button class="download-selector__trigger">
            <span>
              <i class="fa-solid fa-file-arrow-down"></i>
              <span class="download-typo">Download</span>
            </span>
            <i class="fas fa-chevron-down download-selector__trigger-icon"></i>
          </button>
          <div class="download-selector__menu" id="downloads">
            <span class="download-selector__option" id="download-pdf">
              <i class="fas fa-file-pdf download-selector__option-icon"></i>
              <span>PDF</span>
            </span>
            <span class="download-selector__option" id="download-xlsx">
              <i class="fas fa-file-excel download-selector__option-icon"></i>
              <span>Excel</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div id="master-table" class="tabulator tabulator-modern"></div>
  </div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
  // ================= DOWNLOAD DROPDOWN UI =================

  const downloadSelector = document.getElementById("downloadSelector");
  const triggerBtn = downloadSelector.querySelector(
    ".download-selector__trigger"
  );

  // Toggle dropdown
  triggerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    downloadSelector.classList.toggle("download-selector--active");

    const icon = triggerBtn.querySelector(
      ".download-selector__trigger-icon"
    );
    icon.style.transform = downloadSelector.classList.contains(
      "download-selector--active"
    )
      ? "rotate(180deg)"
      : "rotate(0deg)";
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", () => {
    downloadSelector.classList.remove("download-selector--active");
    const icon = triggerBtn.querySelector(
      ".download-selector__trigger-icon"
    );
    icon.style.transform = "rotate(0deg)";
  });

  // Prevent close when clicking inside dropdown
  downloadSelector
    .querySelector(".download-selector__menu")
    .addEventListener("click", (e) => {
      e.stopPropagation();
    });

  // ================= TABULATOR DATA =================

    // Render data from Express (passed into EJS)
    let tableData = [];
    try {
      tableData = JSON.parse('<%- JSON.stringify(jsonData || []) %>');
    } catch (err) {
      console.error("Master Disp JSON error", err);
    }

  tableData.forEach((user) => {
    user.labelCount = user.labelCount ?? 0;
    user.ttrCount = user.ttr?.length || 0;
    user.tapeCount = user.tape?.length || 0;
  });

  // ================= TABULATOR INIT =================

  let table; // MUST be global for download to work

  function initTable() {

    table = new Tabulator("#master-table", {
      data: tableData,
      layout: "fitColumns",
      virtualDom: true,
      responsiveLayout: false,
      pagination: "local",
      paginationSize: 30,
      movableColumns: true,
      placeholder: "No data to display",
      columns: [
        {
          title: "Client Name",
          field: "clientName",
          headerFilter: "input",
          headerFilterPlaceholder: "Search",
        },
        {
          title: "Client Type",
          field: "clientType",
          headerSort: false,
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "All",
              DEALER: "DEALER",
              CLIENT: "CLIENT",
            },
            clearable: true,
          },
        },
        {
          title: "Account Head",
          field: "accountHead",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "User Name",
          field: "userName",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Location",
          field: "userLocation",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Department",
          field: "userDepartment",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Contact",
          field: "userContact",
          headerSort: false,
        },
        {
          title: "Email",
          field: "userEmail",
          headerSort: false,
        },
        {
          title: "Self Dispatch",
          field: "SelfDispatch",
          headerSort: false,
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "All",
              "SELF DISPATCH": "SELF DISPATCH",
              "THIRD PARTY": "THIRD PARTY",
            },
            clearable: true,
          },
        },
        {
          title: "Labels",
          field: "labelCount",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<span style="cursor:pointer;color:blue;text-decoration:underline;">${row.labelCount}</span>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            window.location.href = `/fairdesk/labels/view/${row._id}`;
          },
        },
        {
          title: "TTR's",
          field: "ttrCount",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<span style="cursor:pointer;color:blue;text-decoration:underline;">${row.ttrCount}</span>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            window.location.href = `/fairdesk/ttr/view/${row._id}`;
          },
        },
        {
          title: "Tapes",
          field: "tapeCount",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<span style="cursor:pointer;color:blue;text-decoration:underline;">${row.tapeCount}</span>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            window.location.href = `/fairdesk/tape/view/${row._id}`;
          },
        },
      ],
    });
  }

  window.addEventListener("load", initTable);

  // ================= DOWNLOAD ACTIONS =================

  // PDF
  document.getElementById("download-pdf").addEventListener("click", () => {
    if (!table) return;

    table.download("pdf", "master-data.pdf", {
      orientation: "landscape",
      title: "Master Data",
    });

    downloadSelector.classList.remove("download-selector--active");
  });

  // Excel
  document.getElementById("download-xlsx").addEventListener("click", () => {
    if (!table) return;

    table.download("xlsx", "master-data.xlsx", {
      sheetName: "Master Data",
    });

    downloadSelector.classList.remove("download-selector--active");
  });
</script>

</body>
