<% layout('/layout/boilerplate') -%>

<!-- ================= TABULATOR CSS ================= -->
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />
<style>
  .no-underline .emp-link {
    text-decoration: none !important;
  }
</style>

<div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
  <div class="indi-head">
    <span style="display: flex; align-items: center; gap: 10px">
      <button
        id="backToSnapshot"
        style="display:none;
               background-color:transparent;
               padding:2px 14px;
               border: 1px solid #f0f0f0;
               border-radius:0.3rem;
               font-weight:500;
               cursor:pointer;">
        <i class="fa-solid fa-arrow-left" style="color: #ffffff;"></i>
      </button>
      <h1>Payroll</h1>      
    </span>

    <div class="download-selector" id="downloadSelector">
      <button class="download-selector__trigger">
        <span>
          <i class="fa-solid fa-file-arrow-down"></i> Download
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>

      <div class="download-selector__menu">
        <div class="download-selector__option" id="download-pdf">
          <i class="fas fa-file-pdf"></i> PDF
        </div>
        <div class="download-selector__option" id="download-xlsx">
          <i class="fas fa-file-excel"></i> Excel
        </div>
      </div>
    </div>
  </div>

  <div id="master-table"></div>
</div>

<!-- ================= SCRIPTS ================= -->

<!-- Tabulator -->
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  /* ================= DOWNLOAD DROPDOWN ================= */

  const downloadSelector = document.getElementById("downloadSelector");
  const triggerBtn = downloadSelector.querySelector(".download-selector__trigger");

  triggerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    downloadSelector.classList.toggle("download-selector--active");
  });

  document.addEventListener("click", () => {
    downloadSelector.classList.remove("download-selector--active");
  });

  downloadSelector
    .querySelector(".download-selector__menu")
    .addEventListener("click", (e) => e.stopPropagation());

  /* ================= TABLE ================= */

  const tableData = <%- JSON.stringify(jsonData) %>;
  const snapshotData = [...tableData];

  const table = new Tabulator("#master-table", {
    data: tableData,
    layout: "fitColumns",
    pagination: "local",
    paginationSize: 30,
    movableColumns: true,

    movableColumns: true,
    columns: [
  {
    title: "Employee Name",
    field: "employeeName",
    minWidth: 180,
    maxWidth: 240,
    formatter: function (cell) {
      const data = cell.getRow().getData();
      return `
        <span
          class="emp-link"
          data-id="${data.employeeId}"
          title="${data.employeeName}"
          style="
            cursor:pointer;
            font-weight:600;
            text-decoration:underline;
            display:block;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
          "
        >
          ${data.employeeName}
        </span>
      `;
    }
  },
  { title: "Employee ID", field: "empId", minWidth: 160 },
  {
  title: "Month",
  field: "month",
  minWidth: 90,
  formatter: function (cell) {
    const months = [
      "Jan", "Feb", "Mar", "Apr", "May", "Jun",
      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];

    const value = cell.getValue();
    return months[value - 1] || value;
  }
},
  { title: "Year", field: "year", minWidth: 80 },
  { title: "Present", field: "presentDays", minWidth: 80 },
  { title: "Absent", field: "absentDays", minWidth: 80 },
  { title: "OT hrs", field: "otHours", minWidth: 80 },
  { title: "Salary", field: "basicSalary", minWidth: 110 },
  { title: "Total Additions", field: "totalAdditions", minWidth: 140 },
  { title: "Incentive", field: "incentive", minWidth: 100 },
  { title: "Gross Salary", field: "grossSalary", minWidth: 130 },
  { title: "Deduction", field: "totalDeduction", minWidth: 120 },
  { title: "Take Away", field: "takeAway", minWidth: 120 },
]

  });

  document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("emp-link")) return;

  document.body.classList.add("no-underline");

  const employeeId = e.target.dataset.id;

  const res = await fetch(
    `/fairdesk/payroll/employee/${employeeId}/payrolls`
  );

  const { history } = await res.json();

  if (!history || !history.length) return;

  // Replace table with full payroll history
  table.replaceData(history);

  document.getElementById("backToSnapshot").style.display = "inline-flex";
});


  /* ================= DOWNLOAD ACTIONS ================= */

  document.getElementById("download-pdf").addEventListener("click", () => {
  table.download("pdf", "payroll.pdf", {
    orientation: "landscape",
    title: "Payroll Data",

    autoTable: {
    startY: 40,
      
    styles: {
      fontSize: 9,
      cellPadding: 4,
      textColor: [26, 26, 46],
    
      lineColor: [210, 210, 210],
      lineWidth: 0.15,
    },
  
    headStyles: {
      fillColor: [26, 26, 46],
      textColor: 255,
      fontStyle: "bold",
    
      lineColor: [200, 200, 200],
      lineWidth: 0.2,
    },
  
    bodyStyles: {
      fillColor: [255, 255, 255],
    },
  
    alternateRowStyles: {
      fillColor: [248, 249, 250],
    },
  
    margin: {
      top: 20,
      left: 14,
      right: 14,
    },
  }
  });

  downloadSelector.classList.remove("download-selector--active");
});


  document.getElementById("download-xlsx").addEventListener("click", () => {
    table.download("xlsx", "payroll.xlsx", {
      sheetName: "Payroll",
    });
    downloadSelector.classList.remove("download-selector--active");
  });

  document
  .getElementById("backToSnapshot")
  .addEventListener("click", () => {
    table.replaceData(snapshotData);
    document.body.classList.remove("no-underline");
    document.getElementById("backToSnapshot").style.display = "none";
  });
</script>
