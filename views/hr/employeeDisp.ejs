<!-- Link to boilerplate.ejs -->
<% layout('/layout/boilerplate') -%>

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />
<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />

<body>
  <div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
    <div class="indi-head">
      <h1>Employees</h1>
      <div class="download-btns">
        <div class="download-selector" id="downloadSelector">
          <button class="download-selector__trigger">
            <span>
              <i class="fa-solid fa-file-arrow-down"></i>
              <span class="download-typo">Download</span>
            </span>
            <i class="fas fa-chevron-down download-selector__trigger-icon"></i>
          </button>
          <div class="download-selector__menu" id="downloads">
            <span class="download-selector__option" id="download-pdf">
              <i class="fas fa-file-pdf download-selector__option-icon"></i>
              <span>PDF</span>
            </span>
            <span class="download-selector__option" id="download-xlsx">
              <i class="fas fa-file-excel download-selector__option-icon"></i>
              <span>Excel</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div id="master-table" class="tabulator tabulator-modern"></div>
  </div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
  // ================= DOWNLOAD DROPDOWN =================

  const downloadSelector = document.getElementById("downloadSelector");
  const triggerBtn = downloadSelector.querySelector(".download-selector__trigger");

  triggerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    downloadSelector.classList.toggle("download-selector--active");

    const icon = triggerBtn.querySelector(".download-selector__trigger-icon");
    icon.style.transform = downloadSelector.classList.contains("download-selector--active")
      ? "rotate(180deg)"
      : "rotate(0deg)";
  });

  document.addEventListener("click", () => {
    downloadSelector.classList.remove("download-selector--active");
    const icon = triggerBtn.querySelector(".download-selector__trigger-icon");
    icon.style.transform = "rotate(0deg)";
  });

  downloadSelector
    .querySelector(".download-selector__menu")
    .addEventListener("click", (e) => e.stopPropagation());

  // ================= DATA =================

  const tableData = <%- JSON.stringify(jsonData) %>;

  // ================= TABULATOR =================

  let table;

  function initTable() {
  table = new Tabulator("#master-table", {
    data: tableData,
    layout: "fitColumns",
    columnMinWidth: 120,
    resizableColumns: true,
    movableColumns: true,
    pagination: "local",
    paginationSize: 30,

    columns: [
      {
        title: "Name",
        field: "empName",
        formatter: function (cell) {
          return `
            <span style="font-weight:600;color:#1a1a2e;text-decoration:underline">
              ${cell.getValue()}
            </span>
          `;
        },
        cellClick: function (e, cell) {
          const data = cell.getRow().getData();
          window.open(
            `/fairdesk/employee/profile/${data._id}`,
            "_blank"
          );
        },
      },

      {
        title: "Employee Id",
        field: "empId",
        width: 150,
        formatter: function (cell) {
          return `
            <span style="font-weight:600;font-size:14px;color:#1a1a2e">
              ${cell.getValue()}
            </span>
          `;
        }
      },
      {
        title: "Image",
        field: "empPhoto",
        width: 80,
        hozAlign: "center",
        formatter: function () {
          return `
            <i class="fa-solid fa-image"
               style="font-size:16px;color:#1a1a2e">
            </i>
          `;
        },
        cellClick: function (e, cell) {
          const data = cell.getRow().getData();
        
          const imgSrc = data.empPhoto
            ? `/images/empimg/${data.empPhoto}`
            : `/images/empimg/${data.empGender === "FEMALE" ? "female.jpg" : "male.jpg"}`;
        
          openImgModal(imgSrc);
        }
      },
      { title: "Reporting Manager", field: "empReportingManager" },
      { title: "Office Mobile", field: "empOfficeMob" },
      { title: "Office Email", field: "empOfficeEmailId" },
      { title: "Employee Type", field: "empType" },
      { title: "Department", field: "empDept" },
      { title: "Location", field: "empLoc" },
    ],
  });
}


  window.addEventListener("load", initTable);

  // ================= DOWNLOAD =================

  document.getElementById("download-pdf").addEventListener("click", () => {
    if (!table) return;

    table.download("pdf", "employee-data.pdf", {
      orientation: "landscape",
      title: "Employee Data",
    });

    downloadSelector.classList.remove("download-selector--active");
  });

  document.getElementById("download-xlsx").addEventListener("click", () => {
    if (!table) return;

    table.download("xlsx", "employee-data.xlsx", {
      sheetName: "Employees",
    });

    downloadSelector.classList.remove("download-selector--active");
  });
</script>
<!-- IMAGE PREVIEW MODAL -->
<div id="imgModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:9999;
" onclick="closeImgModal()">
  <img id="imgModalSrc" style="
    max-width:90%;
    max-height:90%;
    border-radius:8px;
    box-shadow:0 10px 40px rgba(0,0,0,0.4);
    background:#fff;
  ">
</div>

<script>
  function openImgModal(src) {
    document.getElementById("imgModalSrc").src = src;
    document.getElementById("imgModal").style.display = "flex";
  }

  function closeImgModal() {
    document.getElementById("imgModal").style.display = "none";
  }
</script>


</body>
