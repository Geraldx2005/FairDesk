<% layout('/layout/boilerplate') -%>

<div class="main-content">
  <form class="rottary-content" method="post" action="/fairdesk/tapestock/create">

    <!-- ================= HEADER ================= -->
    <div class="span-full form-heading" style="display:flex; justify-content:space-between; flex-direction:row;">

      <!-- ================= LOCATION ================= -->
      <div class="span-five" style="display:flex; gap:6px; justify-content:start; flex-direction:row; width:auto;">
        <label style="width:auto;">Location</label>
        <select name="location" id="locationSelect" class="form-control select-tag" style="width:130px" required >
          <option value="" disabled selected hidden>Select Location</option>
          <option value="UNIT 1">UNIT 1</option>
          <option value="UNIT 2">UNIT 2</option>
          <option value="UNIT 3">UNIT 3</option>
        </select>
      </div>

      <!-- ================= TITLE ================= -->
      <h1>Tape Stock Entry</h1>

      <!-- ================= CURRENT STOCK ================= -->
      <div class="span-five" id="stockWrap" style="display:flex; gap:6px; justify-content:end; flex-direction:row; width:auto;">
        <label style="width:auto;">Current Stock</label>
        <input type="number" id="currentStock" class="form-control input-tag" style="width:100px" value="0" readonly />
      </div>
    </div>

    <!-- ================= TAPE SPECS ================= -->
    <div class="span-five">
      <label>Tape ID</label>
      <input type="text" id="resolvedTape" class="form-control input-tag" placeholder="ID will appear here" readonly />
      <input type="hidden" name="tapeId" id="resolvedTapeId" />
    </div>

    <div class="span-four">
      <label for="tape-paper-code">Paper Code</label>
      <select name="tapePaperCode" id="tape-paper-code" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <% paperCodes?.forEach(pc => { %>
          <option value="<%= pc %>"><%= pc %></option>
        <% }) %>
      </select>
    </div>
    <div class="span-four">
      <label for="tape-paper-type">Paper Type</label>
      <select name="tapePaperType" id="tape-paper-type" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <% paperTypes?.forEach(pt => { %>
          <option value="<%= pt %>"><%= pt %></option>
        <% }) %>
      </select>
    </div>
    <div class="span-three">
      <label for="tape-gsm">GSM</label>
      <select name="tapeGsm" id="tape-gsm" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <% gsms?.forEach(g => { %>
          <option value="<%= g %>"><%= g %></option>
        <% }) %>
      </select>
    </div>
    <div class="span-four">
      <label for="tape-width">Width</label>
      <select name="tapeWidth" id="tape-width" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <% widths?.forEach(w => { %>
          <option value="<%= w %>"><%= w %></option>
        <% }) %>
      </select>
    </div>
    <div class="span-four">
      <label for="tape-mtrs">MTRS</label>
      <select name="tapeMtrs" id="tape-mtrs" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <% mtrsList?.forEach(m => { %>
          <option value="<%= m %>"><%= m %></option>
        <% }) %>
      </select>
    </div>                        
    <div class="span-four">
      <label for="tape-core-id">Core ID</label>
       <select name="tapeCoreId" id="tape-core-id" class="form-control select-tag" required>
        <option value="" disabled selected hidden>Search</option>
        <option value="3">3</option>
        <option value="1">1</option>
        <option value="0.5">0.5</option>
      </select>             
    </div>
    <div class="span-four">
      <label for="tape-finish">Finish</label>
       <select name="tapeFinish" id="tape-finish" class="form-control select-tag" required>
        <option value="" selected disabled hidden>Select </option>
        <option value="MATTE">MATTE</option>
        <option value="GLOSSY">GLOSSY</option>
      </select>             
    </div>
    
    <!-- NO BUTTON NEEDED, AUTO RESOLVE -->
    <!-- 
    <div class="span-full btn-grp">
      <button type="button" id="resolveTapeBtn" class="btn-secondary">
        Get Tape ID
      </button>
    </div> 
    -->

    <!-- ================= RESOLVED TAPE ================= -->
    <div class="span-full form-subheading"></div>

    <!-- ================= QUANTITY ================= -->
    <div class="span-seven">
      <label>Quantity</label>
      <input type="number" name="quantity" class="form-control input-tag" min="1" placeholder="Enter Quantity" required />
    </div>

    <div class="span-half" style="grid-column: span 25;">
      <label>Remarks</label>
      <input type="text" name="remarks" class="form-control input-tag" placeholder="Enter Remarks" />
    </div>

    <div class="span-full btn-grp">
      <button type="submit" id="submitBtn" disabled>Save Stock</button>
    </div>

  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const locationSelect = document.getElementById("locationSelect");
  const stockInput = document.getElementById("currentStock");
  
  const resolvedTape = document.getElementById("resolvedTape");
  const resolvedTapeId = document.getElementById("resolvedTapeId");
  const submitBtn = document.getElementById("submitBtn");

  const tapeFields = [
    "tape-paper-code",
    "tape-paper-type",
    "tape-gsm",
    "tape-width",
    "tape-mtrs",
    "tape-core-id",
    "tape-finish",
  ];

  /* ================= CONFIG ================= */
  const fieldToApiKey = {
    "tape-paper-code": "paperCodes",
    "tape-paper-type": "paperTypes",
    "tape-gsm": "gsms",
    "tape-width": "widths",
    "tape-mtrs": "mtrsList",
    "tape-core-id": "coreIds",
    "tape-finish": "finishes",
  };

  const fieldToParam = {
    "tape-paper-code": "tapePaperCode",
    "tape-paper-type": "tapePaperType",
    "tape-gsm": "tapeGsm",
    "tape-width": "tapeWidth",
    "tape-mtrs": "tapeMtrs",
    "tape-core-id": "tapeCoreId",
    "tape-finish": "tapeFinish",
  };

  /* ================= CHOICES INIT ================= */
  const specChoices = {};
  tapeFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      specChoices[id] = new Choices(el, {
        searchEnabled: true,
        shouldSort: false,
        itemSelectText: "",
      });
    }
  });

  /* ================= SMART FILTER ================= */
  async function filterSpecs(changedFieldId) {
    const params = new URLSearchParams();
    tapeFields.forEach(id => {
      const el = document.getElementById(id);
      if (el && el.value) {
        params.set(fieldToParam[id], el.value);
      }
    });

    try {
      const res = await fetch(`/fairdesk/tapestock/filter-specs?${params}`);
      const data = await res.json();
      if (!data) return;

      tapeFields.forEach(id => {
        const choicesInstance = specChoices[id];
        if (!choicesInstance) return;

        const apiKey = fieldToApiKey[id];
        const filteredValues = data[apiKey] || [];
        const currentValue = document.getElementById(id)?.value || "";

        const newChoices = filteredValues.map(v => ({
          value: String(v),
          label: String(v),
          selected: String(v) === currentValue,
        }));

        choicesInstance.clearStore();
        choicesInstance.setChoices(
          [{ value: "", label: "Search", disabled: true, selected: !currentValue }, ...newChoices],
          "value",
          "label",
          true
        );
      });
    } catch (err) {
      console.error("Filter specs error:", err);
    }
  }

  /* ================= RESOLVE ================= */
  async function resolveTape() {
    // Collect all values
    const values = {};
    for (let id of tapeFields) {
      const el = document.getElementById(id);
      if (!el || !el.value) return; // Incomplete
      values[id] = el.value;
    }

    const res = await fetch("/fairdesk/tapestock/resolve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        paperCode: values["tape-paper-code"],
        paperType: values["tape-paper-type"],
        gsm: values["tape-gsm"],
        width: values["tape-width"],
        mtrs: values["tape-mtrs"],
        coreId: values["tape-core-id"],
        finish: values["tape-finish"]
      })     
    });

    const data = await res.json();

    if (!data.found) {
      resolvedTape.value = "No matching tape found";
      resolvedTapeId.value = "";
      stockInput.value = 0;
      submitBtn.disabled = true;
      return;
    }

    resolvedTape.value = data.TapeProductId;
    resolvedTapeId.value = data.tapeId;
    submitBtn.disabled = false;

    if (locationSelect.value) fetchStock();
  }

  /* ================= STOCK FETCH ================= */
  async function fetchStock() {
    if (!resolvedTapeId.value || !locationSelect.value) return;
    const res = await fetch(`/fairdesk/tapestock/balance/${resolvedTapeId.value}/${locationSelect.value}`);
    const data = await res.json();
    stockInput.value = data.stock ?? 0;
  }

  /* ================= HANDLERS ================= */
  tapeFields.forEach(id => {
    document.getElementById(id)?.addEventListener("change", async () => {
      await filterSpecs(id);
      resolveTape();
    });
  });

  locationSelect.addEventListener("change", fetchStock);
});
</script>
