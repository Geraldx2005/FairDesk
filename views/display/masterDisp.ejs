<!-- Link to boilerplate.ejs -->
<% layout('/layout/boilerplate') -%>

<!-- Tabulator CSS -->
<link
  href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
  rel="stylesheet"
/>
<link
  href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator_modern.min.css"
  rel="stylesheet"
/>

<style>
  #master-table {
    height: 100%;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
  }

  input {
    height: 20px;
    padding: 6px;
    border-radius: 6px;
    font-size: 12px;
    background-color: #f8f9fa !important;
    border: 1px solid #ced4da;
    flex-grow: 1;
    outline: none;
  }

  .tabulator .tabulator-tableholder {
    overflow-y: auto !important;
  }

  .tabulator .tabulator-header {
    background-color: #1a1a2e !important;
  }

  .tabulator .tabulator-col,
  .tabulator .tabulator-col-content {
    background-color: #1a1a2e !important;
    color: #fff !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    padding: 2px 4px !important;
  }

  .tabulator .tabulator-cell {
    font-size: 14px;
    border: 2px solid transparent;
    padding: 2px 4px !important;
    transition: all 0.1s ease-in-out;
    outline: 0.75px solid rgba(128, 128, 128, 0.25);
  }

  .tabulator .tabulator-cell:hover {
    border: 2px solid #1a1a2e;
  }

  .tabulator .tabulator-row {
    transition: all 0.2s ease-in-out;
  }

  .tabulator .tabulator-row:hover {
    background-color: rgba(140, 154, 173, 0.3) !important;
    color: #0f172a !important;
    cursor: pointer;
    border: none !important;
    transition: all 0.2s ease;
  }

  .tabulator .tabulator-tableholder,
  .tabulator .tabulator-table {
    background-color: #f8f9fa !important;
  }

  /* Target the table scrollbars */
  .tabulator .tabulator-tableholder::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-track {
    background: #f0f2f5;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb {
    background: #1a1a2e;
    border-radius: 6px;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb:hover {
    background: #1a1a2e;
  }

  /* Firefox */
  .tabulator .tabulator-tableholder {
    scrollbar-width: thin;
    scrollbar-color: #1a1e2e #f0f2f5;
  }

  .side-nav {
    transition: transform 1s;
  }
  .side-nav.animate {
    will-change: transform;
  }
</style>
</head>

<body>
  <div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
    <div class="span-full form-subheading" style="width: 100%">
      <h1>Master display</h1>
    </div>
    <div id="master-table" class="tabulator tabulator-modern"></div>
  </div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <script>
    // Render data from Express (passed into EJS)
    const tableData = JSON.parse('<%- JSON.stringify(jsonData) %>');

    tableData.forEach((user) => {
      user.labelCount = user.label?.length || 0;
      user.ttrCount = user.ttr?.length || 0;
      user.tapeCount = user.tape?.length || 0;
    });

    console.log(tableData);

    //Build Tabulator
    var table = new Tabulator("#master-table", {
      data: tableData,
      layout: "fitDataTable",
      virtualDom: true,
      responsiveLayout: false,
      pagination: "local",
      paginationSize: 30,
      movableColumns: true,
      columns: [
        {
          title: "Client Name",
          field: "clientName",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Client Type",
          field: "clientType",
          headerSort: false,
          headerFilter: "select",
          headerFilterParams: { values: true },
        },
        {
          title: "Head Location",
          field: "hoLocation",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Account Head",
          field: "accountHead",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "User Name",
          field: "userName",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "User Location",
          field: "userLocation",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "User Department",
          field: "userDepartment",
          headerSort: false,
          headerFilter: "select",
          headerFilterParams: { values: true },
        },
        {
          title: "User Contact",
          field: "userContact",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "User Email",
          field: "userEmail",
          headerSort: false,
          headerFilter: "input",
        },
        {
          title: "Self Dispatch",
          field: "SelfDispatch",
          headerSort: false,
          headerFilter: "select",
          headerFilterParams: { values: true },
        },
        {
          title: "Labels",
          field: "labelCount",
          headerSort: false,
          headerFilter: "number",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<div style="cursor:pointer;color:blue;text-decoration:underline;">${row.labelCount}</div>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            // Simply navigate to the labels page instead of using fetch
            window.location.href = `/fairdesk/disp/labels/${row._id}`;
          },
        },
        {
          title: "TTR's",
          field: "ttrCount",
          headerSort: false,
          headerFilter: "number",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<div style="cursor:pointer;color:blue;text-decoration:underline;">${row.ttrCount}</div>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            // Fixed the URL path for TTR
            window.location.href = `/fairdesk/disp/ttr/${row._id}`;
          },
        },
        {
          title: "Tapes",
          field: "tapeCount",
          headerSort: false,
          headerFilter: "number",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `<div style="cursor:pointer;color:blue;text-decoration:underline;">${row.tapeCount}</div>`;
          },
          cellClick: (e, cell) => {
            const row = cell.getRow().getData();
            // Fixed the URL path for Tapes
            window.location.href = `/fairdesk/disp/tapes/${row._id}`;
          },
        },
      ],
    });
  </script>
</body>