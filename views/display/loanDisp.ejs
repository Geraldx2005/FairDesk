<% layout('/layout/boilerplate') -%>

<!-- ================= TABULATOR CSS ================= -->
<link
  href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
  rel="stylesheet"
/>

<style>
  #master-table {
    height: 100%;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
  }

  input {
    height: 20px;
    padding: 6px;
    border-radius: 6px;
    font-size: 12px;
    background-color: #f8f9fa !important;
    border: 1px solid #ced4da;
    flex-grow: 1;
    outline: none;
  }

  .tabulator .tabulator-tableholder {
    overflow-y: auto !important;
  }

  .tabulator .tabulator-header {
    background-color: #1a1a2e !important;
  }

  .tabulator .tabulator-col,
  .tabulator .tabulator-col-content {
    background-color: #1a1a2e !important;
    color: #fff !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    padding: 2px 4px !important;
  }

  .tabulator .tabulator-cell {
    font-size: 14px;
    font-weight: 500;
    color: #1a1e2e !important;
    border: 2px solid transparent;
    padding: 2px 4px !important;
    transition: all 0.1s ease-in-out;
    outline: 0.75px solid rgba(128, 128, 128, 0.25);
  }

  .tabulator .tabulator-cell:hover {
    border: 2px solid #1a1a2e;
  }

  .tabulator .tabulator-row {
    transition: all 0.2s ease-in-out;
  }

  .tabulator .tabulator-row:hover {
    background-color: rgba(140, 154, 173, 0.3) !important;
    color: #0f172a !important;
    cursor: pointer;
    border: none !important;
    transition: all 0.2s ease;
  }

  .tabulator .tabulator-tableholder,
  .tabulator .tabulator-table {
    background-color: #f8f9fa !important;
  }

  /* Target the table scrollbars */
  .tabulator .tabulator-tableholder::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-track {
    background: #f0f2f5;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb {
    background: #1a1a2e;
    border-radius: 6px;
  }

  .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb:hover {
    background: #1a1a2e;
  }

  /* Firefox */
  .tabulator .tabulator-tableholder {
    scrollbar-width: thin;
    scrollbar-color: #1a1e2e #f0f2f5;
  }

  .side-nav {
    transition: transform 1s;
  }

  .side-nav.animate {
    will-change: transform;
  }

  .download-btns {
    display: flex;
    justify-content: center;
    align-items: center;
    color: #0f172a;
  }

  .download-btns button {
    height: 20px;
  }

  .download-btns button:hover {
    background-color: rgba(255, 255, 255, 0.85);
  }

  /* The download document dropdown */
  .download-selector {
    position: relative;
    display: inline-block;
    width: 160px; /* Fixed width for the dropdown */
  }

  .download-selector__trigger {
    background-color: #f0f0f0;
    color: #1a1a2e;
    padding: 2px 14px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .download-selector__trigger-icon {
    font-size: 12px;
    transition: all 0.2s ease-in-out;
  }

  .download-selector__menu {
    position: absolute;
    background-color: rgb(240, 240, 240);
    width: 100%;
    border: 1px solid #1a1a2e;
    border-radius: 0.5rem;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.2s ease-in-out;
    right: 0;
    margin-top: 12px;
  }

  .download-selector--active .download-selector__menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .download-selector__option {
    color: #1a1a2e;
    padding: 8px 10px;
    font-size: 15px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease-in-out;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background-color: rgb(240, 240, 240);
    border-radius: 0.5rem;
    cursor: pointer;
    width: auto;
    height: auto;
  }

  .download-selector__option:hover {
    background-color: rgb(216, 216, 216);
    border-radius: 0.5rem;
  }

  .download-selector__option-icon {
    width: 20px;
    color: #1a1a2e;
  }

  .download-typo {
    margin-left: 2px;
  }

  .indi-head {
    width: 100%;
    border-radius: 0.5rem;
    padding: 0.4rem 0.8rem;
    background-color: #1a1a2e;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-direction: row;
  }

  .indi-head h1 {
    margin: 0;
    font-size: 1.25rem;
  }

  /* Remove the "x" clear button in Tabulator header filters */
  .tabulator
    .tabulator-header
    .tabulator-col
    .tabulator-header-filter
    input[type='search']::-webkit-search-cancel-button {
    -webkit-appearance: none;
    appearance: none;
  }

  .tabulator
    .tabulator-header
    .tabulator-col
    .tabulator-header-filter
    input[type='search']::-ms-clear {
    display: none;
  }

  .tabulator
    .tabulator-header
    .tabulator-col
    .tabulator-header-filter
    input[type='search']::-ms-reveal {
    display: none;
  }

  /* Remove sort arrows from Tabulator header */
  .tabulator .tabulator-col .tabulator-arrow {
    display: none !important;
  }
  
  /* Also remove space reserved for arrow */
  .tabulator .tabulator-col .tabulator-col-title {
    padding-right: 0 !important;
  }
</style>

<div class="contain" style="flex-direction: column; padding: 10px; gap: 10px">
  <div class="indi-head">
    <h1>Loans</h1>

    <div class="download-selector" id="downloadSelector">
      <button class="download-selector__trigger">
        <span>
          <i class="fa-solid fa-file-arrow-down"></i> Download
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>

      <div class="download-selector__menu">
        <div class="download-selector__option" id="download-pdf">
          <i class="fas fa-file-pdf"></i> PDF
        </div>
        <div class="download-selector__option" id="download-xlsx">
          <i class="fas fa-file-excel"></i> Excel
        </div>
      </div>
    </div>
  </div>

  <div id="master-table"></div>
</div>

<!-- ================= SCRIPTS ================= -->

<!-- Tabulator -->
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  /* ===== Dropdown ===== */
  const downloadSelector = document.getElementById("downloadSelector");
  const triggerBtn = downloadSelector.querySelector(".download-selector__trigger");

  triggerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    downloadSelector.classList.toggle("download-selector--active");
  });

  document.addEventListener("click", () => {
    downloadSelector.classList.remove("download-selector--active");
  });

  downloadSelector
    .querySelector(".download-selector__menu")
    .addEventListener("click", (e) => e.stopPropagation());

  /* ===== Table ===== */
  const tableData = <%- JSON.stringify(jsonData) %>;

const table = new Tabulator("#master-table", {
  data: tableData,

  layout: "fitColumns",      // ✅ auto-fit columns
  columnMinWidth: 120,       // ✅ prevents ultra-thin columns
  resizableColumns: true,
  movableColumns: true,

  pagination: "local",
  paginationSize: 30,

    columns: [
    { title: "Employee Name", field: "employeeName" },
    { title: "Employee ID", field: "empId" },
    { title: "Current Balance", field: "currentBalance" },
    { title: "Status", field: "status" },
    { title: "Last Updated", field: "updatedAt" },
  ],
});

  /* ===== Downloads ===== */
  document.getElementById("download-pdf").addEventListener("click", () => {
    table.download("pdf", "loan-data.pdf", {
      orientation: "landscape",
      title: "Loan Data",
    });
    downloadSelector.classList.remove("download-selector--active");
  });

  document.getElementById("download-xlsx").addEventListener("click", () => {
    table.download("xlsx", "loan-data.xlsx", {
      sheetName: "Loans",
    });
    downloadSelector.classList.remove("download-selector--active");
  });
</script>
