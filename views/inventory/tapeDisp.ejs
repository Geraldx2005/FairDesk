<!-- Link to boilerplate.ejs -->
<% layout('/layout/boilerplate') -%>

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />
<link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator_modern.min.css" rel="stylesheet">
</head>

<body>
<div class="contain" style="flex-direction: column; padding: 10px; gap: 10px" >
      <div class="indi-head">
        <h1>Tapes</h1>
        <div class="download-btns">
          <div class="download-selector" id="downloadSelector">
            <button class="download-selector__trigger">
              <span>
                <i class="fa-solid fa-file-arrow-down"></i>
                <span class="download-typo">Download</span>
              </span>
              <i class="fas fa-chevron-down download-selector__trigger-icon"></i>
            </button>
            <div class="download-selector__menu" id="downloads">
              <span class="download-selector__option" id="download-pdf">
                <i class="fas fa-file-pdf download-selector__option-icon"></i>
                <span>PDF</span>
              </span>
              <span class="download-selector__option" id="download-xlsx">
                <i class="fas fa-file-excel download-selector__option-icon"></i>
                <span>Excel</span>
              </span>
            </div>
          </div>
      </div>
    </div>

    <div id="master-table" class="tabulator tabulator-modern"></div>
</div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Render data from Express (passed into EJS)
    const tableData = JSON.parse('<%- JSON.stringify(jsonData) %>');

    // Initialize Tabulator
    const table = new Tabulator("#master-table", {
      data: tableData,
      layout: "fitDataTable", // expand to fit content + allow horizontal scroll
      responsiveLayout: false,
      pagination: "local",
      paginationSize: 30,
      movableColumns: true,
      placeholder: "No data to display",
      columns: [
        {
          title: "",
          formatter: function (cell) {
            const row = cell.getRow().getData();
          
            // tape master object already present
            const tapeMaster = row.tapeId;
          
            if (!tapeMaster || !tapeMaster._id) {
              return `<span style="color:#999">N/A</span>`;
            }
          
            return `
              <button 
                onclick="window.location.href='/fairdesk/tape/profile/${tapeMaster._id}'"
                style="padding:2px 10px;background:#1a1a2e;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">
                <i class="fa-solid fa-eye"></i>
              </button>
            `;
          }
        },
        {
          title: "Stock",
          field: "stock",
          hozAlign: "center",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            const stock = row.stock ?? "-";
            return `<span style="font-weight:600">${stock}</span>`;
          }
        },
        {
          title: "Order",
          hozAlign: "center",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            return `
              <button 
                onclick="window.location.href='/fairdesk/sales/order?type=TAPE&client=${encodeURIComponent(row.userId.clientName)}&user=${row.userId._id}&item=${row._id}'"
                style="padding:2px 10px;background:#1a1a2e;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">
                <i class="fa-solid fa-cart-plus"></i>
              </button>
            `;
          }
        },
        { title: "User Name", field: "userId.userName" },
        { title: "User Contact", field: "userId.userContact" },
        { title: "Location", field: "userId.hoLocation" },
        { title: "Client GSM", field: "clientTapeGsm" },
        { title: "Paper Type", field: "tapeId.tapePaperType" },
        { title: "Width", field: "tapeId.tapeWidth" },
        { title: "Mtrs", field: "tapeId.tapeMtrs" },
        { title: "Mtrs Del", field: "tapeMtrsDel" },
        { title: "Core ID", field: "tapeId.tapeCoreId" },
        { title: "Rate Per Roll", field: "tapeRatePerRoll" },
        { title: "Min Qty", field: "tapeMinQty" },
        { title: "Order Qty", field: "tapeOdrQty" },
      ]
    });

    // Dropdown toggle
    const selector = document.getElementById("downloadSelector");
    const trigger = selector.querySelector(".download-selector__trigger");

    trigger.addEventListener("click", (e) => {
      e.stopPropagation();
      selector.classList.toggle("download-selector--active");
    });

    // Close dropdown on outside click
    document.addEventListener("click", () => {
      selector.classList.remove("download-selector--active");
    });

    // PDF download
    document.getElementById("download-pdf").addEventListener("click", () => {
      table.download("pdf", "tapes.pdf", {
        orientation: "landscape",
        title: "Tapes Data",
      });
      selector.classList.remove("download-selector--active");
    });

    // Excel download
    document.getElementById("download-xlsx").addEventListener("click", () => {
      table.download("xlsx", "tape.xlsx", {
        sheetName: "Tapes",
      });
      selector.classList.remove("download-selector--active");
    });

  </script>
</body>