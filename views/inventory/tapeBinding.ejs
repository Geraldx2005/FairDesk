<% layout('/layout/boilerplate') %>
    <style>
      .tape-id-success {
      border: 2px solid #28a745 !important;
      background-color: #f3fff6;
      color: #155724;
      font-weight: 600;
    }

    .tape-id-error {
      border: 2px solid #dc3545 !important;
      background-color: #fff5f5;
      color: #721c24;
      font-weight: 600;
    }
    </style>

      <!-- The main content -->
      <div class="main-content">
        <form action="/fairdesk/form/tape-binding" method="post" onsubmit="return validateTapeBeforeSubmit()" class="needs-validation" autocomplete="off" novalidate>
          <div class="span-full form-heading">
            <h1>Client Tape</h1>
          </div>

          <div class="span-full form-subheading">
            <h1>User Info</h1>
          </div>

          <div id="tape-id-div" class="span-seven">
            <label for="tape-id">Tape ID</label>
            <input type="text" id="tape-id" class="form-control" name="tapeProductId" placeholder="Will appear here" readonly required />
          </div>                  

          <div id="client-name-div" class="span-six">
            <div class="clientName-label"><label for="client-name">Client Name</label><span class="asterisk" style="font-size: 14px;"></span></div>
            <select name="clientName" id="client-name" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% for (let client of clients) { %>
              <option value="<%= client %>"><%= client %></option>
              <% } %>
            </select>
          </div>  

          <div id="user-name-div" class="span-six">
            <label>User Name</label>
            <select id="client-user-name" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
            </select>
          </div>
          <div id="user-name-contact-div" class="span-six">
            <label for="user-contact">User Contact</label>
            <input type="text" id="user-contact" class="form-control" name="userContact" placeholder="Enter User Contact" required />
          </div>
          <div id="client-location-div" class="span-seven">
            <label for="client-location">Location</label>
            <input type="text" id="client-location" class="form-control" name="location" placeholder="Enter Location" required />
          </div>

          <div class="span-full form-subheading">
            <h1>Tape Specifications</h1>
          </div>

          <div class="span-five">
            <label>Paper Code</label>
            <select name="tapePaperCode" id="tape-paper-code" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% paperCodes?.forEach(pc => { %>
                <option value="<%= pc %>"><%= pc %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-five">
            <label>Paper Type</label>
            <select name="tapePaperType" id="tape-paper-type" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% paperTypes?.forEach(pt => { %>
                <option value="<%= pt %>"><%= pt %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-four">
            <label>GSM</label>
            <select name="tapeGsm" id="tape-gsm" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% gsms?.forEach(g => { %>
                <option value="<%= g %>"><%= g %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-four">
            <label>Width</label>
            <select name="tapeWidth" id="tape-width" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% widths?.forEach(w => { %>
                <option value="<%= w %>"><%= w %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-five">
            <label>MTRS</label>
            <select name="tapeMtrs" id="tape-mtrs" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% mtrsList?.forEach(m => { %>
                <option value="<%= m %>"><%= m %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-five">
            <label for="tape-core-id">Core ID</label>
            <select name="tapeCoreId" id="tape-core-id" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% coreIds?.forEach(c => { %>
                <option value="<%= c %>"><%= c %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-four">
            <label for="tape-finish">Finish</label>
            <select name="tapeFinish" id="tape-finish" class="form-control select-tag" required>
              <option value="" disabled selected hidden>Search</option>
              <% finishes?.forEach(f => { %>
                <option value="<%= f %>"><%= f %></option>
              <% }) %>
            </select>
          </div>

          <div class="span-full form-subheading">
            <h1>Client Overrides</h1>
          </div>
          
          <div class="span-seven">
            <label for="tape-client-paper-code">Client Paper Code</label>
            <input type="text" id="tape-client-paper-code" class="form-control" name="tapeClientPaperCode" placeholder="Enter Client Paper Code" required />
          </div>
          <div class="span-seven">
            <label for="tape-client-gsm">Client GSM</label>
            <input type="text" id="tape-client-gsm" class="form-control" name="clientTapeGsm" placeholder="Enter Client GSM" required />
          </div>

          <div class="span-six">
            <label for="tape-mtrs-del">MTRS Delivered</label>
            <input type="text" id="tape-mtrs-del" class="form-control" name="tapeMtrsDel" placeholder="Enter MTRS Delivered" required />
          </div>          
          <div class="span-six">
            <label for="tape-rate-per-roll">Rate Per Roll</label>
            <input type="text" id="tape-rate-per-roll" class="form-control" name="tapeRatePerRoll" placeholder="Enter rate per roll" required />
          </div>            
          <div class="span-six">
            <label for="tape-sale-cost">Sales sq mtrs Cost</label>
            <input type="text" id="tape-sale-cost" class="form-control" name="tapeSaleCost" placeholder="Enter Sales Cost" tabindex="-1" required readonly />
          </div>           

          <div class="span-full form-subheading">
            <h1>Pricing & Order Terms</h1>
          </div>

          <div class="span-dual">
            <label for="tape-min-qty">Minimum Order QTY</label>
            <input type="text" id="tape-min-qty" class="form-control" name="tapeMinQty" placeholder="Enter minimum qty" required />
          </div>
          <div class="span-dual">
            <label for="tape-odr-qty">Order QTY</label>
            <input type="text" id="tape-odr-qty" class="form-control" name="tapeOdrQty" placeholder="Enter order qty" required />
          </div>
          <div class="span-dual">
            <label for="tape-odr-freq">Repeat Order Freq</label>
            <input type="text" id="tape-odr-freq" class="form-control" name="tapeOdrFreq" placeholder="Enter repeat order frequency" required />
          </div>
          <div class="span-dual">
            <label for="tape-credit-term">CR</label>
            <input type="text" id="tape-credit-term" class="form-control" name="tapeCreditTerm" placeholder="Enter credit term" required />
          </div>

          <input type="hidden" name="tapeId" id="resolved-tape-id">
          <input type="hidden" name="userId" id="user-id">

          <div class="btn-grp span-full">
            <button type="submit">Save tape</button>
          </div>          
        </form>
      </div>

<!-- ===== RATE CALCULATION ===== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ================= ELEMENTS ================= */
  const submitBtn = document.querySelector("button[type='submit']");

  const clientSelect = document.getElementById("client-name");
  const userSelect = document.getElementById("client-user-name");

  const userIdInput = document.getElementById("user-id");
  const userContactInput = document.getElementById("user-contact");
  const locationInput = document.getElementById("client-location");

  const tapeIdInput = document.getElementById("resolved-tape-id");
  const tapeIdDisplay = document.getElementById("tape-id");

  const tapeFields = [
    "tape-paper-code",
    "tape-paper-type",
    "tape-gsm",
    "tape-width",
    "tape-mtrs",
    "tape-core-id",
    "tape-finish",
  ];

  // Map from element ID to the API response key
  const fieldToApiKey = {
    "tape-paper-code": "paperCodes",
    "tape-paper-type": "paperTypes",
    "tape-gsm": "gsms",
    "tape-width": "widths",
    "tape-mtrs": "mtrsList",
    "tape-core-id": "coreIds",
    "tape-finish": "finishes",
  };

  // Map from element ID to the query param name
  const fieldToParam = {
    "tape-paper-code": "tapePaperCode",
    "tape-paper-type": "tapePaperType",
    "tape-gsm": "tapeGsm",
    "tape-width": "tapeWidth",
    "tape-mtrs": "tapeMtrs",
    "tape-core-id": "tapeCoreId",
    "tape-finish": "tapeFinish",
  };

  submitBtn.disabled = true;

  /* ================= CHOICES INIT ================= */
  new Choices(clientSelect, {
    searchEnabled: true,
    shouldSort: false,
    itemSelectText: "",
  });

  const userChoices = new Choices(userSelect, {
    searchEnabled: true,
    shouldSort: false,
    itemSelectText: "",
  });

  // Store Choices instances for spec fields
  const specChoices = {};
  tapeFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      specChoices[id] = new Choices(el, {
        searchEnabled: true,
        shouldSort: false,
        itemSelectText: "",
      });
    }
  });

  /* ================= HELPERS ================= */
  function resetUserFields() {
    userIdInput.value = "";
    userContactInput.value = "";
    locationInput.value = "";
  }

  function hardResetUserSelection() {
    userChoices.removeActiveItems();
    userChoices.clearChoices();
    resetUserFields();
  }

  function resetResolvedTape() {
    tapeIdInput.value = "";
    tapeIdDisplay.value = "";
    submitBtn.disabled = true;
    tapeIdDisplay.classList.remove("tape-id-success", "tape-id-error");
  }

  /* ================= SMART FILTER ================= */
  let filterTimeout = null;

  async function filterSpecs(changedFieldId) {
    // Build query params from all currently selected values
    const params = new URLSearchParams();
    tapeFields.forEach(id => {
      const el = document.getElementById(id);
      if (el && el.value) {
        params.set(fieldToParam[id], el.value);
      }
    });

    try {
      const res = await fetch(`/fairdesk/form/tape-binding/filter-specs?${params}`);
      const data = await res.json();
      if (!data) return;

      // Update each dropdown with filtered options (except the one just changed)
      tapeFields.forEach(id => {
        const choicesInstance = specChoices[id];
        if (!choicesInstance) return;

        const apiKey = fieldToApiKey[id];
        const filteredValues = data[apiKey] || [];
        const currentValue = document.getElementById(id)?.value || "";

        // Build new choices array
        const newChoices = filteredValues.map(v => ({
          value: String(v),
          label: String(v),
          selected: String(v) === currentValue,
        }));

        // Clear and repopulate
        choicesInstance.clearStore();
        choicesInstance.setChoices(
          [{ value: "", label: "Search", disabled: true, selected: !currentValue }, ...newChoices],
          "value",
          "label",
          true
        );
      });
    } catch (err) {
      console.error("Filter specs error:", err);
    }
  }

  /* ================= CLIENT → USER ================= */
  clientSelect.addEventListener("change", async () => {
    const clientName = clientSelect.value;

    hardResetUserSelection();

    const res = await fetch(`/fairdesk/form/tape-binding/client/${clientName}`);
    const clientData = await res.json();
    if (!clientData || !clientData.users) return;

    // ===== SINGLE USER =====
    if (clientData.users.length === 1) {
      const u = clientData.users[0];

      userChoices.setChoices(
        [{
          value: u._id,
          label: u.userName,
          selected: true,
          customProperties: {
            mobile: u.userContact || "",
            location: u.userLocation || ""
          }
        }],
        "value",
        "label",
        true
      );

      userIdInput.value = u._id;
      userContactInput.value = u.userContact || "";
      locationInput.value = u.userLocation || "";
      return;
    }

    // ===== MULTIPLE USERS =====
    userChoices.setChoices(
      clientData.users.map(u => ({
        value: u._id,
        label: u.userName,
        customProperties: {
          mobile: u.userContact || "",
          location: u.userLocation || ""
        }
      })),
      "value",
      "label",
      true
    );

    resetUserFields();
  });

  /* ================= USER CHANGE ================= */
  userSelect.addEventListener("change", () => {
    const selectedId = userChoices.getValue(true);
    if (!selectedId) return;

    const choice = userChoices._store.choices.find(
      c => c.value === selectedId
    );
    if (!choice) return;

    userIdInput.value = choice.value;
    userContactInput.value = choice.customProperties?.mobile || "";
    locationInput.value = choice.customProperties?.location || "";
  });

  /* ================= TAPE RESOLVE ================= */
  async function resolveTape() {
    resetResolvedTape();

    const values = {};
    for (let id of tapeFields) {
      const el = document.getElementById(id);
      if (!el || !el.value) return;
      values[id] = el.value;
    }

    const params = new URLSearchParams({
      tapePaperCode: values["tape-paper-code"],
      tapePaperType: values["tape-paper-type"],
      tapeGsm: values["tape-gsm"],
      tapeWidth: values["tape-width"],
      tapeMtrs: values["tape-mtrs"],
      tapeCoreId: values["tape-core-id"],
      tapeFinish: values["tape-finish"],
    });

    const res = await fetch(
      `/fairdesk/form/tape-binding/resolve-tape?${params}`
    );

    if (!res.ok) {
      tapeIdDisplay.value = "No matching tape found";
      tapeIdDisplay.classList.add("tape-id-error");
      return;
    }

    const data = await res.json();

    tapeIdInput.value = data.tapeId;
    tapeIdDisplay.value = data.tapeProductId;
    tapeIdDisplay.classList.add("tape-id-success");
    submitBtn.disabled = false;

    document.getElementById("tape-client-paper-code").value =
      values["tape-paper-code"];
    document.getElementById("tape-client-gsm").value =
      values["tape-gsm"];
  }

  /* ================= SPEC CHANGE HANDLER ================= */
  tapeFields.forEach(id => {
    document.getElementById(id)?.addEventListener("change", async () => {
      await filterSpecs(id);
      resolveTape();
    });
  });

  /* ================= RATE CALC ================= */
  const widthInput = document.getElementById("tape-width");
  const mtrsInput = document.getElementById("tape-mtrs");
  const ratePerRollInput = document.getElementById("tape-rate-per-roll");
  const saleCostInput = document.getElementById("tape-sale-cost");

  function calcSaleCost() {
    if (!widthInput.value || !mtrsInput.value || !ratePerRollInput.value) return;
    const area = (Number(widthInput.value) * Number(mtrsInput.value)) / 1000;
    if (!area) return;
    saleCostInput.value =
      (Number(ratePerRollInput.value) / area).toFixed(4);
  }

  widthInput.addEventListener("input", calcSaleCost);
  mtrsInput.addEventListener("input", calcSaleCost);
  ratePerRollInput.addEventListener("input", calcSaleCost);
});

/* ================= CUSTOM TOAST ================= */
function showClientToast(message, isError = true) {
  // Check if existing toast exists, remove it
  const existingToast = document.getElementById("client-toast");
  if (existingToast) {
    existingToast.remove();
  }

  const toast = document.createElement("div");
  toast.id = "client-toast";
  toast.className = `toast-notification ${isError ? 'toast-error' : 'toast-success'}`;
  toast.innerHTML = `
    <span>${message}</span>
    <span class="toast-close" onclick="this.parentElement.remove()">×</span>
  `;

  document.body.appendChild(toast);

  // Auto remove
  setTimeout(() => {
    if (toast.parentElement) {
       toast.style.animation = "slideOut 0.5s forwards";
       setTimeout(() => toast.remove(), 500);
    }
  }, 5000);
}

/* ================= FORM GUARD ================= */
function validateTapeBeforeSubmit() {
  const tapeId = document.getElementById("resolved-tape-id").value;
  if (!tapeId) {
    showClientToast("Please select valid tape specifications.", true);
    return false;
  }

  const minQty = Number(document.getElementById("tape-min-qty").value);
  const odrQty = Number(document.getElementById("tape-odr-qty").value);

  if (minQty >= odrQty) {
    showClientToast("Order Quantity must be greater than Minimum Order Quantity", true);
    return false;
  }

  return true;
}
</script>